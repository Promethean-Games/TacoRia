<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Taco Ria</title>

  <style>
    :root{
      --bg:#050608;
      --bg2:#0a0c10;
      --panel:#0c0f14;
      --text:#f3f4f6;
      --muted:rgba(243,244,246,.70);
      --muted2:rgba(243,244,246,.52);

      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);

      --accent:#00e5ff;
      --accentSoft: rgba(0,229,255,.14);

      --danger:#ff3b30;

      --radius:20px;
      --pad:16px;
      --gap:12px;
      --shadow: 0 18px 45px rgba(0,0,0,.55);

      --navH:56px;
      color-scheme: dark;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(900px 380px at 18% 0%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(780px 360px at 85% 10%, rgba(255,255,255,.05), transparent 65%),
        radial-gradient(820px 420px at 50% 115%, rgba(0,0,0,.75), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      width:100%;
      margin:0 auto;
      max-width: 980px;
    }
    @media (max-width: 430px){ .shell{ max-width: 390px; } }

    header{
      padding: 14px 14px 10px;
      min-height:56px;
    }
    main{
      flex:1;
      padding: 0 14px calc(var(--navH) + env(safe-area-inset-bottom) + 18px);
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .row > *{ min-width:0; }
    .wrap{ flex-wrap:wrap; }
    .sp{ justify-content:space-between; }

    .pageTitle{
      font-weight:1000;
      letter-spacing:.2px;
      line-height:1.08;
      font-size: clamp(20px, 4.7vw, 28px);
    }
    .small{ font-size:12px; }
    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.065), rgba(255,255,255,.035));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
    }

    .heroPhase{ position:relative; overflow:hidden; }
    .heroPhase::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(600px 240px at 20% 0%, rgba(255,255,255,.08), transparent 65%),
        radial-gradient(520px 240px at 85% 10%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(540px 260px at 50% 120%, rgba(0,0,0,.60), transparent 55%);
      pointer-events:none;
    }
    .heroPhase > *{ position:relative; z-index:1; }

    .pills{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.30);
      font-weight:900;
      font-size:12px;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    button{
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.35);
      color:var(--text);
      border-radius: 18px;
      padding: 12px 14px;
      font-weight:1000;
      letter-spacing:.2px;
      cursor:pointer;
      touch-action: manipulation;
      user-select:none;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    button:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .btnTiny{ padding:8px 10px; border-radius:14px; font-size:12px; }
    .ghost{ background: rgba(0,0,0,.20); }
    .primary{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06), 0 0 20px rgba(0,0,0,.55);
    }
    .danger{
      background: linear-gradient(180deg, rgba(255,59,48,.22), rgba(255,59,48,.10));
      border-color: rgba(255,59,48,.35);
    }

    /* Jumbo gameplay buttons */
    .jumbo{
      min-height: 64px;
      font-size: 18px;
      border-radius: 20px;
      width:100%;
    }
    @media (max-width: 430px){
      .jumbo{ min-height: 68px; font-size: 19px; }
    }

    @keyframes pulseGlow{
      0%   { transform: translateY(0); box-shadow: 0 0 0 1px rgba(255,255,255,.06), 0 0 18px rgba(0,0,0,.55); }
      50%  { transform: translateY(-1px); box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 0 32px rgba(0,229,255,.28); }
      100% { transform: translateY(0); box-shadow: 0 0 0 1px rgba(255,255,255,.06), 0 0 18px rgba(0,0,0,.55); }
    }
    .pulse{ animation: pulseGlow 1.55s ease-in-out infinite; }
    .pulseOrder{ animation: pulseGlow 1.25s ease-in-out infinite; }
    .inactive{ opacity:.55; }

    /* Sticky action tray above bottom nav */
    .actionsTray{
      position: sticky;
      bottom: calc(var(--navH) + env(safe-area-inset-bottom));
      z-index: 30;
    }
    @media (max-width: 520px), (max-height: 720px){
      .actionsTray{ position: static; bottom: auto; }
    }
    .actionsStack{ display:flex; flex-direction:column; gap:10px; }

    /* Hand pills */
    .tiles{ display:flex; flex-wrap:wrap; gap:8px; }
    .tile{
      max-width:100%;
      overflow-wrap:anywhere;
      border-radius: 999px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.14);
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      --catTint: rgba(255,255,255,.06);
      background: linear-gradient(135deg, var(--catTint), rgba(0,0,0,.45));
    }
    .tile.sel{
      outline: 2px solid rgba(0,229,255,.55);
      transform: translateY(-1px);
      background:
        linear-gradient(180deg, var(--accentSoft), rgba(0,0,0,0)),
        linear-gradient(135deg, var(--catTint), rgba(0,0,0,.45));
    }
    .tile.wild{ border-color: rgba(255,255,255,.28); box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; }

    .handGroups{ display:flex; flex-direction:column; gap:12px; }
    .handGroup{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(0,0,0,.22);
      padding:10px;
    }
    .handGroupTitle{
      font-weight:1000;
      font-size:12px;
      letter-spacing:.18px;
      color: var(--muted);
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .handGroupTitle .count{ opacity:.75; font-weight:1000; }

    /* Category tinting */
    .tile.cat-tortilla{ --catTint: rgba(255,204,0,.18); border-color: rgba(255,204,0,.30); }
    .tile.cat-protein { --catTint: rgba(255,59,48,.16);  border-color: rgba(255,59,48,.28); }
    .tile.cat-cheese  { --catTint: rgba(255,245,200,.14); border-color: rgba(255,245,200,.24); }
    .tile.cat-wet     { --catTint: rgba(0,229,255,.14); border-color: rgba(0,229,255,.24); }
    .tile.cat-drytop  { --catTint: rgba(163,255,18,.12); border-color: rgba(163,255,18,.22); }
    .tile.cat-wild    { --catTint: rgba(255,255,255,.10); border-color: rgba(255,255,255,.26); }
    .tile.cat-other   { --catTint: rgba(179,107,255,.14); border-color: rgba(179,107,255,.24); }

    /* Public line */
    .pubGroup{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(255,255,255,.03);
      padding:12px;
      margin-bottom:12px;
    }
    .pubGroupTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:1000;
      margin-bottom: 8px;
    }
    .pubDishRow{
      border:1px solid var(--stroke);
      border-radius:16px;
      background: rgba(0,0,0,.45);
      padding:10px;
      margin-top:10px;
      position:relative;
      overflow:hidden;
      cursor:pointer;
    }
    .pubDishRow::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(135deg, var(--tintA), transparent 70%);
      opacity:.95;
      pointer-events:none;
    }
    .pubDishRow > *{ position:relative; z-index:1; }
    .pubDishMeta{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:1000;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.30);
      font-weight:900;
      font-size:12px;
    }
    .dishSel{
      outline: 2px solid rgba(0,229,255,.55);
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 0 30px rgba(0,229,255,.18);
    }

    /* Accordion */
    details.acc{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    details.acc + details.acc{ margin-top:10px; }
    details.acc summary{
      list-style:none;
      cursor:pointer;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:1000;
    }
    details.acc summary::-webkit-details-marker{ display:none; }
    .accBody{ padding: 0 14px 14px; }
    .field{ margin-top:10px; }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:900; }
    .hint{ font-size:12px; color:var(--muted); margin-top:8px; line-height: 1.35; }

    .controllerRow{
      flex:1;
      min-width: 200px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.30);
    }
    .controllerRow span:first-child{
      font-weight:900;
      color: rgba(255,255,255,.85);
    }
    .controllerKey{
      padding:6px 12px;
      border-radius:8px;
      background: rgba(0,229,255,.18);
      border:1px solid rgba(0,229,255,.35);
      color: var(--accent);
      font-weight:900;
      font-size:12px;
    }

    select, input[type="number"]{
      width:100%;
      padding:12px 40px 12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background:#0b0b0b;
      color: rgba(255,255,255,.92);
      font-weight: 900;
      appearance:none;
      -webkit-appearance:none;
      outline:none;
    }
    select option{ background:#0b0b0b; color: rgba(255,255,255,.92); }
    .selectWrap{ position:relative; }
    .selectWrap::after{
      content:"▾";
      position:absolute;
      right:14px; top:50%;
      transform: translateY(-50%);
      opacity:.75;
      pointer-events:none;
      font-weight:1000;
    }

    nav.footer{
      position:fixed;
      left:0; right:0; bottom:0;
      height: var(--navH);
      padding-bottom: env(safe-area-inset-bottom);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      z-index: 40;
    }
    .navBtn{
      flex:1;
      min-height:56px;
      border:none;
      border-right: 1px solid rgba(255,255,255,.06);
      background: transparent;
      color: rgba(255,255,255,.86);
      font-weight:1000;
      border-radius: 0;
      padding: 10px 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      letter-spacing:.15px;
    }
    .navBtn:last-child{ border-right:none; }
    .navBtn.active{
      color:#fff;
      background: radial-gradient(320px 120px at 50% 0%, rgba(0,229,255,.20), transparent 60%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }

    #toastWrap{
      position:fixed;
      left:0; right:0;
      bottom: calc(var(--navH) + env(safe-area-inset-bottom) + 12px);
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index: 80;
    }
    .toast{
      max-width:min(560px, calc(100% - 24px));
      background: rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,.65);
      font-weight: 900;
      pointer-events:none;
    }

    /* Modal */
    #modalWrap{
      position:fixed; inset:0;
      background: var(--bg);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 90;
    }
    #modalWrap.on{ display:flex; }
    .modal{
      width: min(560px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: 0 22px 60px rgba(0,0,0,.70);
      padding: 14px;
    }
    .modal h3{ margin: 4px 0 8px; font-size: 18px; }
    .modal .body{ color: var(--muted); font-weight: 900; line-height: 1.35; }
    .modal .foot{ margin-top: 12px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .page{ display:none; }
    .page.on{ display:block; }

    /* Prep Table */
    .prepRow{
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(0,0,0,.26);
      padding: 12px;
      overflow:hidden;
    }
    .prepTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      font-weight:1000;
    }
    .prepSlots{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
    }
    @media (max-width: 430px){
      .prepSlots{ grid-template-columns: repeat(2, 1fr); }
    }
    .slot{
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.20);
      background: rgba(255,255,255,.03);
      padding: 10px;
      min-height: 58px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      user-select:none;
      cursor:pointer;
    }
    .slot.filled{
      border-style: solid;
      border-color: rgba(255,255,255,.18);
      background:
        linear-gradient(180deg, var(--accentSoft), rgba(0,0,0,0)),
        rgba(0,0,0,.30);
    }
    .slot .sName{
      font-weight: 1000;
      font-size: 13px;
      color: rgba(243,244,246,.94);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:100%;
    }
    .slot .sHint{
      font-weight: 900;
      font-size: 12px;
      color: rgba(243,244,246,.42);
    }

    /* Draw Modal (3 pick) */
    .drawMeta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .drawRow{
      display:flex;
      gap:12px;
      margin-top: 12px;
      width:100%;
    }
    .drawRow.busy{ pointer-events:none; opacity:.98; }
    .drawRow .tileCard{ flex:1; min-width:0; }

    @media (max-width: 430px){ .drawRow{ gap:10px; } }
    @media (max-width: 360px){ .drawRow{ gap:8px; } }

    @keyframes slowShimmer{
      0%   { transform: translateX(-12%); opacity:.22; }
      50%  { transform: translateX(12%);  opacity:.32; }
      100% { transform: translateX(-12%); opacity:.22; }
    }
    @keyframes slowBreath{
      0%   { box-shadow: 0 10px 26px rgba(0,0,0,.55); transform: translateY(0); }
      50%  { box-shadow: 0 14px 32px rgba(0,0,0,.66); transform: translateY(-1px); }
      100% { box-shadow: 0 10px 26px rgba(0,0,0,.55); transform: translateY(0); }
    }

    .tileCard{ perspective: 900px; min-height: 94px; }
    @media (max-width: 430px){ .tileCard{ min-height: 86px; } }

    .tileFlip{
      position:relative;
      width:100%;
      height:100%;
      transform-style:preserve-3d;
      transition: transform 650ms cubic-bezier(.2,.9,.2,1);
      border-radius:18px;
    }
    .tileFace{
      position:absolute;
      inset:0;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      overflow:hidden;
      backface-visibility:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 10px 8px;
      user-select:none;
    }

    /* Default: NO shimmer. Enable only in Difficult/Master via body.strictShimmer */
    .tileBack{
      background: url('attached_assets/image_1766622696657.png') center/cover no-repeat;
      cursor:pointer;
    }

    body.strictShimmer .tileBack{ animation: slowBreath 4.6s ease-in-out infinite; }

    .tileBackInner{
      display: none;
    }
    .tilePickOutline{
      outline: 2px solid rgba(0,229,255,.55);
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 0 30px rgba(0,229,255,.24);
    }

    .tileFront{
      transform: rotateY(180deg);
      background:
        radial-gradient(420px 160px at 15% 0%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.55));
      border-color: rgba(255,255,255,.18);
    }
    .tileFront .frontName{
      font-weight:1000;
      font-size: 14px;
      color: rgba(243,244,246,.95);
      padding: 0 4px;
    }
    .tileFlip.reveal{ transform: rotateY(180deg); }

    /* Tutorial pager */
    .tutWrap{
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: rgba(0,0,0,.22);
    }
    .tutStrip{
      display:flex;
      width:100%;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
    }
    .tutPage{
      flex: 0 0 100%;
      scroll-snap-align:start;
      padding: 14px;
      min-height: 260px;
    }
    .tutTitle{ font-weight:1000; font-size:16px; margin-bottom:8px; color: rgba(243,244,246,.94); }
    .tutText{ color: var(--muted); font-weight:900; line-height:1.35; margin-top:10px; }
    .tutImg{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      display:block;
      background: rgba(255,255,255,.02);
    }
    .tutDots{
      display:flex; gap:8px; justify-content:center;
      margin-top:10px;
      opacity:.85;
    }
    .dot{
      width:8px; height:8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.05);
    }
    .dot.on{ background: rgba(0,229,255,.45); border-color: rgba(0,229,255,.55); }

    @media (max-width: 520px){
      button, .tile, .navBtn { touch-action: manipulation; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <header>
      <div class="row sp">
        <div>
          <div class="row" style="gap:10px;">
            <div class="pageTitle" id="appNameH">Taco Ria</div>
          </div>
          <div class="muted small" id="subTitle">Private Prep • Public Line • Remix</div>
        </div>
        <button class="ghost btnTiny" id="btnNewMatchTop">New Match</button>
      </div>
    </header>

    <main>
      <!-- GAMEPLAY -->
      <section class="page on" id="pageGameplay">
        <div class="card heroPhase" style="margin-bottom:12px;">
          <div class="pills" style="margin-top:2px;">
            <span class="pill" id="tilesRemainBadge">Tiles Remaining 0</span>
            <span class="pill" id="kitchenBadge">Kitchen Closed</span>
            <span class="pill" id="handBadge">Hand 1/12</span>
            <span class="pill" id="turnBadge">Your Turn</span>
          </div>

          <div style="margin-top:12px;">
            <div style="font-weight:1000; font-size:16px;" id="phaseTitle">Not Seated Yet</div>
            <div class="muted" id="phaseDesc">Serve 10+ points in one turn to open the kitchen.</div>
          </div>
        </div>

        <div class="actionsTray">
          <div class="card">
            <div class="actionsStack">
              <button class="primary jumbo" id="btnPrep">Prep a Dish</button>
              <button class="danger jumbo" id="btnEndTurn">End Turn</button>
            </div>
            <div class="muted small" style="margin-top:10px;" id="actionHint">
              Prep your ingredients, then Order Up. One draw per turn.
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="row sp" style="margin-bottom:10px;">
            <div style="font-weight:1000;">Public Line / Window</div>
            <span class="pill" id="lineSummary">0 dishes</span>
          </div>
          <div id="publicLine"></div>
        </div>
      </section>

      <!-- PREP -->
      <section class="page" id="pagePrep">
        <div class="card">
          <div class="row sp" style="margin-bottom:8px;">
            <div style="font-weight:1000;">Prep Table</div>
            <span class="badge" id="prepTurnBadge">Your Turn</span>
          </div>

          <div class="prepRow" style="margin-bottom:12px;">
            <div class="prepTop">
              <div>Prep Window</div>
              <div class="muted2 small" id="prepLoadedHint">0/10 loaded</div>
            </div>
            <div class="prepSlots" id="prepSlots"></div>
            <div class="muted small" style="margin-top:10px;" id="prepStatus">No dish detected yet.</div>
          </div>

          <!-- Prominent controls under Order Up -->
          <div class="actionsStack" style="margin-bottom:12px;">
            <button class="primary jumbo" id="btnDraw">Draw Tile</button>
            <button class="primary jumbo" id="btnOrderUpFromPrep">Order Up!</button>
            <div class="row wrap" style="gap:10px; justify-content:space-between;">
              <button class="primary" id="btnAutoPlate" style="flex:1; min-width:160px;">Auto-Plate</button>
              <button class="ghost" id="btnClearPrep" style="flex:1; min-width:160px;">Clear Prep</button>
            </div>
            <button class="ghost" id="btnAutoRemix" style="display:none;">Auto-Remix</button>
          </div>

          <details class="acc" open>
            <summary>
              <span>Your Hand</span>
              <span class="muted2 small" id="handCountHint">0 tiles</span>
            </summary>
            <div class="accBody">
              <div id="handTiles"></div>
              <div class="hint" id="handHint" style="margin-top:10px;">
                Tap hand tiles to add/remove them from your Prep Window.
              </div>
            </div>
          </details>

          <details class="acc">
            <summary>
              <span>Menu Guide</span>
              <span class="muted2 small">Reference</span>
            </summary>
            <div class="accBody" id="menuGuideBody"></div>
          </details>
        </div>
      </section>

      <!-- REMIX (simple MVP: extend one dish by 1 tile, +1 point) -->
      <section class="page" id="pageRemix">
        <div class="card">
          <div class="row sp" style="margin-bottom:10px;">
            <div style="font-weight:1000;">Remix</div>
            <span class="badge" id="remixGateBadge">Kitchen Closed</span>
          </div>

          <div class="muted small" id="remixHint" style="margin-bottom:10px;">
            Select 1 tile from your hand, then tap a dish to add it. +1 point for a legal remix.
          </div>

          <div class="card" style="padding:12px; margin-bottom:12px;">
            <div class="row sp" style="margin-bottom:10px;">
              <div style="font-weight:1000;">Public Line</div>
              <span class="pill" id="remixLineSummary">0 dishes</span>
            </div>
            <div id="remixPublicLine"></div>
          </div>

          <details class="acc" open>
            <summary>
              <span>Your Hand</span>
              <span class="muted2 small" id="remixHandCountHint">0 tiles</span>
            </summary>
            <div class="accBody">
              <div id="remixHandTiles"></div>
              <div class="hint" style="margin-top:10px;">
                Only one hand tile can be selected for a remix.
              </div>
            </div>
          </details>
        </div>
      </section>

      <!-- SCORES -->
      <section class="page" id="pageScores">
        <div class="card">
          <div class="row sp" style="margin-bottom:10px;">
            <div style="font-weight:1000;">Scores</div>
            <span class="badge" id="scoreModePill">Standard</span>
          </div>

          <div class="row wrap" style="gap:10px; margin-bottom:12px;">
            <span class="pill" id="scoreCurrent">Current: 0</span>
            <span class="pill muted" id="scoreServedMuted">Served this hand: 0</span>
          </div>

          <div id="scoreList"></div>

          <div class="hint" style="margin-top:10px;">
            Player panels are collapsed by default. Expand to see dishes served and remix net.
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section class="page" id="pageSettings">
        <div class="card">
          <div class="row sp" style="margin-bottom:10px;">
            <div style="font-weight:1000;">Settings</div>
          </div>
          <div class="muted small">Primary theme stays black. Choose a high-contrast accent.</div>

          <details class="acc" open style="margin-top:12px;">
            <summary>
              <span>Match</span>
              <span class="muted2 small">Mode + Players</span>
            </summary>
            <div class="accBody">
              <div class="row wrap" style="gap:12px;">
                <div style="flex:1; min-width: 160px;">
                  <div class="label">Mode</div>
                  <div class="selectWrap">
                    <select id="selMode">
                      <option value="standard">Standard Match</option>
                      <option value="campaign">Campaign</option>
                    </select>
                  </div>
                </div>
                <div style="flex:1; min-width: 160px;">
                  <div class="label">Players</div>
                  <div class="selectWrap">
                    <select id="selPlayers">
                      <option value="2">2 Players</option>
                      <option value="3">3 Players</option>
                      <option value="4" selected>4 Players</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="row wrap" style="gap:12px; margin-top:10px;">
                <div style="flex:1; min-width: 160px;">
                  <div class="label">CPU Difficulty (Standard only)</div>
                  <div class="selectWrap">
                    <select id="selDifficulty"></select>
                  </div>
                </div>
                <div style="flex:1; min-width: 160px;">
                  <div class="label">Hands (Standard only)</div>
                  <input type="number" id="inpHands" min="1" max="12" value="12" />
                </div>
              </div>

              <div class="row wrap" style="gap:12px; margin-top:10px;">
                <div style="flex:1; min-width: 160px;">
                  <div class="label">Tiles per Player</div>
                  <input type="number" id="inpTilesPerPlayer" min="8" max="24" value="16" />
                </div>
                <div style="flex:1; min-width: 160px;">
                  <div class="label">Decks</div>
                  <div class="selectWrap">
                    <select id="selDecks">
                      <option value="1">1 Deck</option>
                      <option value="2" selected>2 Decks (Recommended)</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </details>

          <details class="acc">
            <summary>
              <span>Theme</span>
              <span class="muted2 small">Accent Color</span>
            </summary>
            <div class="accBody">
              <div class="label">Accent</div>
              <div class="selectWrap">
                <select id="selAccent"></select>
              </div>
              <div class="hint">CPU colors will auto-adjust to avoid matching you or each other.</div>
            </div>
          </details>

          <details class="acc">
            <summary>
              <span>Language</span>
              <span class="muted2 small">EN / ES / FR / DE</span>
            </summary>
            <div class="accBody">
              <div class="label">App Language</div>
              <div class="selectWrap">
                <select id="selLang">
                  <option value="en">English</option>
                  <option value="es">Español</option>
                  <option value="fr">Français</option>
                  <option value="de">Deutsch</option>
                </select>
              </div>
            </div>
          </details>

          <details class="acc">
            <summary>
              <span>Tutorial</span>
              <span class="muted2 small">View / Hide</span>
            </summary>
            <div class="accBody">
              <button class="primary" id="btnViewTutorial">View Tutorial</button>
              <div class="hint">Hide stops auto-popups. You can always reopen it here.</div>
              <div class="field">
                <button class="ghost" id="btnToggleTutorialHidden">Hide Tutorial: Off</button>
              </div>
            </div>
          </details>

          <details class="acc">
            <summary>
              <span>USB Controller</span>
              <span class="muted2 small">Default Inputs</span>
            </summary>
            <div class="accBody">
              <div class="label">ACTION BUTTONS</div>
              <div class="row wrap" style="gap:10px; margin-bottom:12px;">
                <div class="controllerRow"><span>A Button</span><span class="controllerKey">X</span></div>
                <div class="controllerRow"><span>B Button</span><span class="controllerKey">B</span></div>
              </div>
              <div class="row wrap" style="gap:10px; margin-bottom:12px;">
                <div class="controllerRow"><span>Start</span><span class="controllerKey">Start</span></div>
                <div class="controllerRow"><span>Z Trigger</span><span class="controllerKey">LT</span></div>
              </div>

              <div class="label" style="margin-top:16px;">SHOULDER BUTTONS</div>
              <div class="row wrap" style="gap:10px; margin-bottom:12px;">
                <div class="controllerRow"><span>L Trigger</span><span class="controllerKey">LB</span></div>
                <div class="controllerRow"><span>R Trigger</span><span class="controllerKey">RB</span></div>
              </div>

              <div class="label" style="margin-top:16px;">C-BUTTONS</div>
              <div class="row wrap" style="gap:10px; margin-bottom:12px;">
                <div class="controllerRow"><span>C-Up</span><span class="controllerKey">R3</span></div>
                <div class="controllerRow"><span>C-Down</span><span class="controllerKey">Y</span></div>
              </div>
              <div class="row wrap" style="gap:10px; margin-bottom:12px;">
                <div class="controllerRow"><span>C-Left</span><span class="controllerKey">A</span></div>
                <div class="controllerRow"><span>C-Right</span><span class="controllerKey">L3</span></div>
              </div>

              <div class="label" style="margin-top:16px;">D-PAD</div>
              <div class="row wrap" style="gap:10px; margin-bottom:12px;">
                <div class="controllerRow"><span>D-Up</span><span class="controllerKey">D-Pad Up</span></div>
                <div class="controllerRow"><span>D-Down</span><span class="controllerKey">D-Pad Down</span></div>
              </div>
              <div class="row wrap" style="gap:10px; margin-bottom:12px;">
                <div class="controllerRow"><span>D-Left</span><span class="controllerKey">D-Pad Left</span></div>
                <div class="controllerRow"><span>D-Right</span><span class="controllerKey">D-Pad Right</span></div>
              </div>

              <div class="label" style="margin-top:16px;">ANALOG STICK</div>
              <div class="row wrap" style="gap:10px; margin-bottom:12px;">
                <div class="controllerRow"><span>Stick Up</span><span class="controllerKey">LY-</span></div>
                <div class="controllerRow"><span>Stick Down</span><span class="controllerKey">LY+</span></div>
              </div>
              <div class="row wrap" style="gap:10px; margin-bottom:12px;">
                <div class="controllerRow"><span>Stick Left</span><span class="controllerKey">LX-</span></div>
                <div class="controllerRow"><span>Stick Right</span><span class="controllerKey">LX+</span></div>
              </div>
            </div>
          </details>
        </div>
      </section>
    </main>
  </div>

  <nav class="footer">
    <button class="navBtn active" id="navGame">Gameplay</button>
    <button class="navBtn" id="navPrep">Prep</button>
    <button class="navBtn" id="navRemix">Remix</button>
    <button class="navBtn" id="navScores">Scores</button>
    <button class="navBtn" id="navSettings">Settings</button>
  </nav>

  <div id="toastWrap"></div>

  <div id="modalWrap">
    <div class="modal">
      <h3 id="modalTitle">Modal</h3>
      <div class="body" id="modalBody"></div>
      <div class="foot" id="modalFoot"></div>
    </div>
  </div>

  <script>
/* =====================================================
  Taco Ria (GitHub-ready) v0.9.2.0.0
  ES5-only compatibility build (no const/let, no arrow funcs, no optional chaining, no template strings)
  Fixes: "Invalid or unexpected token" / dead buttons caused by modern syntax.
====================================================== */

(function(){
  "use strict";

  var VERSION = "v0.9.2.0.0";
  var LS_KEY  = "taco_ria_state_v092000_es5";

  function $(id){ return document.getElementById(id); }

  // --- minimal polyfills ---
  if (!Element.prototype.closest){
    Element.prototype.closest = function(s){
      var el = this;
      while(el && el.nodeType === 1){
        if (el.matches && el.matches(s)) return el;
        el = el.parentElement || el.parentNode;
      }
      return null;
    };
  }
  if (!Element.prototype.matches){
    Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
  }

  // --- helpers ---
  function escapeHtml(s){
    s = (s === null || s === undefined) ? "" : String(s);
    return s.replace(/&/g,"&amp;")
            .replace(/</g,"&lt;")
            .replace(/>/g,"&gt;")
            .replace(/"/g,"&quot;")
            .replace(/'/g,"&#039;");
  }
  function randInt(n){ return Math.floor(Math.random() * n); }
  function shuffle(a){
    for (var i=a.length-1;i>0;i--){
      var j = Math.floor(Math.random()*(i+1));
      var t = a[i]; a[i]=a[j]; a[j]=t;
    }
    return a;
  }
  function nowId(prefix){
    prefix = prefix || "id";
    return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function hexToRgba(hex, a){
    hex = (hex || "#ffffff").replace("#","").trim();
    var full = hex.length === 3 ? (hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]) : (hex + "000000").slice(0,6);
    var n = parseInt(full, 16);
    var r=(n>>16)&255, g=(n>>8)&255, b=n&255;
    return "rgba(" + r + "," + g + "," + b + "," + a + ")";
  }
  function groupBy(arr, keyFn){
    var m = {};
    arr = arr || [];
    for (var i=0;i<arr.length;i++){
      var it = arr[i];
      var k = keyFn(it);
      if(!m[k]) m[k] = [];
      m[k].push(it);
    }
    return m;
  }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  // --- toast ---
  function toast(msg, ms){
    ms = ms || 2200;
    var wrap = $("toastWrap");
    if(!wrap) return;
    wrap.innerHTML = '<div class="toast">' + escapeHtml(msg) + '</div>';
    if(toast._t) clearTimeout(toast._t);
    toast._t = setTimeout(function(){ wrap.innerHTML=""; }, ms);
  }

  // --- modal ---
  var modalMode = null;
  function openModal(title, htmlBody, footButtons){
    $("modalTitle").textContent = title;
    $("modalBody").innerHTML = htmlBody;
    var foot = $("modalFoot");
    foot.innerHTML = "";
    footButtons = footButtons || [];
    for (var i=0;i<footButtons.length;i++){
      (function(b){
        var btn = document.createElement("button");
        btn.className = b.className || "ghost";
        btn.textContent = b.text || "OK";
        btn.onclick = function(){
          if (typeof b.onClick === "function") b.onClick();
        };
        foot.appendChild(btn);
      })(footButtons[i]);
    }
    $("modalWrap").classList.add("on");
  }
  function closeModal(){
    $("modalWrap").classList.remove("on");
    $("modalBody").onclick = null;
    modalMode = null;
  }

  // --- i18n ---
  var I18N = {
    en:{ gameplay:"Gameplay", prep:"Prep", remix:"Remix", scores:"Scores", settings:"Settings", orderUp:"Order Up!", drawTile:"Draw Tile", endTurn:"End Turn", prepDish:"Prep a Dish", cancel:"Cancel", close:"Close", start:"Start", hide:"Hide" },
    es:{ gameplay:"Gameplay", prep:"Preparacion", remix:"Remix", scores:"Puntos", settings:"Ajustes", orderUp:"Orden lista!", drawTile:"Robar ficha", endTurn:"Terminar turno", prepDish:"Preparar plato", cancel:"Cancelar", close:"Cerrar", start:"Iniciar", hide:"Ocultar" },
    fr:{ gameplay:"Gameplay", prep:"Prepa", remix:"Remix", scores:"Scores", settings:"Reglages", orderUp:"A l'envoi!", drawTile:"Piocher", endTurn:"Fin du tour", prepDish:"Preparer", cancel:"Annuler", close:"Fermer", start:"Demarrer", hide:"Masquer" },
    de:{ gameplay:"Gameplay", prep:"Vorbereiten", remix:"Remix", scores:"Punkte", settings:"Einstellungen", orderUp:"Bestellung raus!", drawTile:"Ziehen", endTurn:"Zug beenden", prepDish:"Vorbereiten", cancel:"Abbrechen", close:"Schliessen", start:"Start", hide:"Ausblenden" }
  };
  function t(key){
    var lang = (state && state.settings && state.settings.lang) ? state.settings.lang : "en";
    var pack = I18N[lang] || I18N.en;
    return pack[key] || I18N.en[key] || key;
  }
  function getAppName(){
    var el = $("appNameH");
    return (el && el.textContent ? el.textContent : (document.title || "Taco Ria")).trim();
  }

  // --- difficulty ---
  var DIFFS = ["Beginner","Easy","Medium","Difficult","Master Chef"];
  var DIFF_DELAY_MS = { "Beginner":5000, "Easy":3500, "Medium":2200, "Difficult":1200, "Master Chef":700 };
  function isLoose(diff){ return diff==="Beginner" || diff==="Easy" || diff==="Medium"; }
  function isStrict(diff){ return diff==="Difficult" || diff==="Master Chef"; }

  // --- accents ---
  var ACCENTS = [
    {name:"Neon Cyan", val:"#00e5ff"},
    {name:"Signal Yellow", val:"#ffcc00"},
    {name:"Lime", val:"#a3ff12"},
    {name:"Hot Pink", val:"#ff2bd6"},
    {name:"Orange", val:"#ff8a00"},
    {name:"Ice", val:"#b3f6ff"},
    {name:"Violet", val:"#b36bff"},
    {name:"Red", val:"#ff3b30"}
  ];
  var CPU_BASE_COLORS = ["#ff3b30","#b36bff","#ffcc00","#a3ff12"];
  function ensureUniqueCpuColors(){
    var used = {};
    used[String((state.settings && state.settings.accent) || "#00e5ff").toLowerCase()] = true;
    var pool = [];
    for(var i=0;i<ACCENTS.length;i++) pool.push(ACCENTS[i].val.toLowerCase());
    var out = [];
    for(var j=0;j<CPU_BASE_COLORS.length;j++){
      var col = CPU_BASE_COLORS[j].toLowerCase();
      if(used[col]){
        for(var k=0;k<pool.length;k++){
          if(!used[pool[k]]){ col = pool[k]; break; }
        }
      }
      used[col] = true;
      out.push(col);
    }
    return out;
  }

  // --- deck (54 cards exact) ---
  var DECK_ING_COUNTS = [
    ["Fish",1],
    ["Ground Beef",2],
    ["Shredded Chicken",2],
    ["Carne Guisada",1],
    ["Beef Fajita",1],
    ["Carnitas",1],
    ["Egg",2],
    ["Chicken Fajita",1],
    ["Chorizo",2],
    ["Tortilla Chips",3],
    ["Flour Tortillas",3],
    ["Corn Tortillas",2],
    ["Shredded yellow Cheese",2],
    ["Shredded white cheese",2],
    ["Rice",2],
    ["Charro Beans",1],
    ["Refried Beans",1],
    ["Black Beans",1],
    ["Cilantro",2],
    ["Jalapenos",1],
    ["Lettuce",1],
    ["Lime Juice",2],
    ["Onion",2],
    ["Tomato",2],
    ["Sour Cream",1],
    ["Avocado",2],
    ["Salsa Roja",2],
    ["Salsa Verde",2],
    ["Queso",2],
    ["Guacamole",3],
    ["Grocery Run",2]
  ];

  function buildDeck(decks){
    decks = decks || 2;
    var tiles = [];
    for (var d=0; d<decks; d++){
      for (var i=0;i<DECK_ING_COUNTS.length;i++){
        var name = DECK_ING_COUNTS[i][0];
        var count = DECK_ING_COUNTS[i][1];
        for (var c=0;c<count;c++){
          tiles.push({ id: nowId("t"), name: name });
        }
      }
    }
    return shuffle(tiles);
  }

  // --- ingredient classification ---
  function isWild(n){ return n==="Grocery Run"; }
  function isTortilla(n){ return n==="Corn Tortillas" || n==="Flour Tortillas"; }
  function isEgg(n){ return n==="Egg"; }
  function isProtein(n){
    return n==="Fish" || n==="Ground Beef" || n==="Shredded Chicken" || n==="Carne Guisada" ||
           n==="Carnitas" || n==="Chicken Fajita" || n==="Beef Fajita" || n==="Chorizo" || n==="Egg";
  }
  function isCheese(n){ return n==="Shredded yellow Cheese" || n==="Shredded white cheese"; }
  function isBean(n){ return n==="Charro Beans" || n==="Refried Beans" || n==="Black Beans"; }
  function isSauce(n){ return n==="Salsa Roja" || n==="Salsa Verde"; }
  function isWet(n){ return n==="Salsa Roja" || n==="Salsa Verde" || n==="Queso" || n==="Guacamole"; } /* Charro Beans is NOT wet */
  function isDip(n){ return n==="Salsa Roja" || n==="Salsa Verde" || n==="Guacamole" || n==="Queso"; }
  function isDryTopping(n){
    return n==="Lettuce" || n==="Onion" || n==="Tomato" || n==="Cilantro" || n==="Jalapenos" || n==="Avocado" ||
           isCheese(n) || n==="Sour Cream";
  }
  function ingredientCategory(name){
    if(isWild(name)) return "wild";
    if(isTortilla(name)) return "tortilla";
    if(isProtein(name)) return "protein";
    if(isCheese(name)) return "cheese";
    if(isWet(name)) return "wet";
    if(isDryTopping(name)) return "drytop";
    return "other";
  }
  function categoryLabel(cat){
    var map = {
      tortilla:"Tortillas", protein:"Proteins", cheese:"Cheese", wet:"Wet Toppings",
      drytop:"Dry Toppings", wild:"Grocery Run", other:"Other"
    };
    return map[cat] || cat;
  }

  // --- scoring/recipes ---
  var GRILL_PROTEINS = { "Fish":true, "Chicken Fajita":true, "Beef Fajita":true };

  var RECIPES = [
    { key:"kidsRiceBeans", name:"Kid's Rice and Beans", base:2, kind:"kids" },
    { key:"breakfastTaco", name:"Breakfast Taco", base:3, kind:"breakfast" },
    { key:"hardTaco", name:"Hard Shell Taco", base:5, kind:"taco", tortilla:"Corn Tortillas" },
    { key:"softTaco", name:"Soft Taco", base:5, kind:"taco", tortilla:"Flour Tortillas" },
    { key:"chorizoTaco", name:"Chorizo Taco", base:8, kind:"chorizo" },
    { key:"chipsDip", name:"Chips & Dip", base:5, kind:"chipsDip" },
    { key:"pico", name:"Pico de Gallo", base:8, kind:"pico" },
    { key:"ench", name:"Enchiladas", base:10, kind:"ench" }
  ];
  function recipeByKey(k){
    for(var i=0;i<RECIPES.length;i++){ if(RECIPES[i].key===k) return RECIPES[i]; }
    return null;
  }

  var RULES = {
    openKitchenTurnPts: 10,
    wetLockedUntilKitchen: true,
    tacoDryLoose: 1,
    tacoDryStrict: 3,
    starterPassDishKeys: ["chipsDip","kidsRiceBeans"] /* one-time, either dish uses it */
  };

  // --- state ---
  function defaultState(){
    return {
      settings:{
        accent:"#00e5ff",
        lang:"en",
        mode:"standard",
        players:4,
        difficulty:"Easy",
        handsTotal:12,
        tilesPerPlayer:16,
        decks:2,
        tutorialHidden:false
      },
      flags:{
        tutorialShownAtStart:false,
        tutorialShownAfterSecondDraw:false,
        p1DrawCount:0
      },
      match:null,
      ui:{ page:"gameplay" }
    };
  }
  function persist(){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){}
  }
  function load(){
    try{
      var raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }
  var state = load() || defaultState();

  // --- players/match ---
  function mkPlayer(id, name, isHuman, color){
    return {
      id:id, name:name, isHuman:isHuman,
      color:color,
      score:0,
      servedThisHand:0,
      hand:[],
      didDrawThisTurn:false,
      prepSelectedIds:[],
      remixSelectedId:null,
      logThisHand:[],
      remixGainThisHand:0,
      remixLossThisHand:0,
      starterPassUsed:false
    };
  }

  function dealInitial(m){
    var tilesPer = state.settings.tilesPerPlayer || 16;
    for(var pid in m.players){
      if(!m.players.hasOwnProperty(pid)) continue;
      var p = m.players[pid];
      p.hand = [];
      p.prepSelectedIds = [];
      p.remixSelectedId = null;
      p.logThisHand = [];
      p.servedThisHand = 0;
      p.remixGainThisHand = 0;
      p.remixLossThisHand = 0;
      p.didDrawThisTurn = false;
      p.starterPassUsed = false;
      for(var i=0;i<tilesPer;i++){
        var t0 = m.bag.pop();
        if(!t0) break;
        p.hand.push(t0);
      }
    }
  }

  function beginTurn(pid){
    var m = state.match;
    var p = m.players[pid];
    p.didDrawThisTurn = false;
    m.servedThisTurnPts = 0;
    if(pid==="P1") p.remixSelectedId = null;
  }

  function p1(){ return state.match.players["P1"]; }

  function applyDifficultyShimmer(){
    var diff = state.settings.difficulty || "Easy";
    document.body.classList.toggle("strictShimmer", isStrict(diff));
  }

  function newMatch(){
    var cpuCols = ensureUniqueCpuColors();
    var pCount = parseInt(state.settings.players,10) || 4;

    var m = {
      id: nowId("m"),
      handIndex: 1,
      kitchenOpen: false,
      bag: buildDeck(parseInt(state.settings.decks,10) || 2),
      publicLine: [],
      players: {},
      activePid: "P1",
      servedThisTurnPts: 0
    };

    m.players["P1"] = mkPlayer("P1","You", true, state.settings.accent);
    if(pCount >= 2) m.players["P2"] = mkPlayer("P2","Chef Mike", false, cpuCols[0]);
    if(pCount >= 3) m.players["P3"] = mkPlayer("P3","Salsa Sam", false, cpuCols[1]);
    if(pCount >= 4) m.players["P4"] = mkPlayer("P4","Queso Queen", false, cpuCols[2]);

    dealInitial(m);
    state.match = m;
    state.ui.page = "gameplay";

    /* reset start/tutorial counters for a fresh match */
    state.flags.p1DrawCount = 0;
    state.flags.tutorialShownAfterSecondDraw = false;

    beginTurn("P1");
    persist();
    render();
    toast("New match started.");
  }

  // --- selection helpers ---
  function selectedTilesFor(pid){
    var m = state.match;
    var p = m && m.players ? m.players[pid] : null;
    var ids = (p && p.prepSelectedIds) ? p.prepSelectedIds : [];
    var hand = (p && p.hand) ? p.hand : [];
    var out = [];
    for(var i=0;i<ids.length;i++){
      var id = ids[i];
      for(var j=0;j<hand.length;j++){
        if(hand[j].id === id){ out.push(hand[j]); break; }
      }
    }
    return out;
  }

  function findTileById(hand, id){
    for(var i=0;i<hand.length;i++){
      if(hand[i].id === id) return hand[i];
    }
    return null;
  }

  // --- draw (3-pick modal) ---
  function pickIndexFromBag(choice){
    var m = state.match;
    var bag = m.bag || [];
    if(!bag.length) return null;

    var side = (choice==="L" || choice==="R");
    var center = (choice==="C");

    var i, idxs, roll;

    if(side){
      idxs = [];
      for(i=0;i<bag.length;i++){
        if(bag[i].name === "Grocery Run") idxs.push(i);
      }
      roll = Math.random();
      if(idxs.length && roll < 0.35){
        return idxs[randInt(idxs.length)];
      }
      return randInt(bag.length);
    }

    if(center){
      idxs = [];
      for(i=0;i<bag.length;i++){
        var nm = bag[i].name;
        /* bias toward "useful" non-wet tiles when kitchen is closed */
        if(state.match && !state.match.kitchenOpen){
          if(!isWet(nm)) idxs.push(i);
        }else{
          idxs.push(i);
        }
      }
      roll = Math.random();
      if(idxs.length && roll < 0.35){
        return idxs[randInt(idxs.length)];
      }
      return randInt(bag.length);
    }

    return randInt(bag.length);
  }

  function openDrawModal(){
    var m = state.match;
    var pl = p1();
    var myTurn = (m.activePid === "P1");

    if(!myTurn){ toast("Not your turn."); return; }
    if(pl.didDrawThisTurn){ toast("Only one draw per turn."); return; }

    var total = m.bag.length;
    if(total === 0){
      openModal(
        t("drawTile"),
        '<div class="muted">No more tiles to choose from.</div>',
        [{ text: t("close"), className:"primary", onClick: closeModal }]
      );
      return;
    }

    var appName = escapeHtml(getAppName());

    var meta = ''
      + '<div class="drawMeta">'
      +   '<span class="pill">Tiles Remaining <span class="mono">' + total + '</span></span>'
      + '</div>'
      + '<div class="muted small">Pick a tile, any tile...</div>';

    var row = ''
      + '<div class="drawRow" id="drawRow">'
      +   '<div class="tileCard" data-draw-choice="L">'
      +     '<div class="tileFlip" id="flip_L">'
      +       '<div class="tileFace tileBack"><div class="tileBackInner">' + appName + '</div></div>'
      +       '<div class="tileFace tileFront"><div class="frontName" id="front_L">—</div></div>'
      +     '</div>'
      +   '</div>'
      +   '<div class="tileCard" data-draw-choice="C">'
      +     '<div class="tileFlip" id="flip_C">'
      +       '<div class="tileFace tileBack"><div class="tileBackInner">' + appName + '</div></div>'
      +       '<div class="tileFace tileFront"><div class="frontName" id="front_C">—</div></div>'
      +     '</div>'
      +   '</div>'
      +   '<div class="tileCard" data-draw-choice="R">'
      +     '<div class="tileFlip" id="flip_R">'
      +       '<div class="tileFace tileBack"><div class="tileBackInner">' + appName + '</div></div>'
      +       '<div class="tileFace tileFront"><div class="frontName" id="front_R">—</div></div>'
      +     '</div>'
      +   '</div>'
      + '</div>';

    openModal(t("drawTile"), meta + row, [
      { text: t("cancel"), className:"ghost", onClick: closeModal }
    ]);

    modalMode = "draw3";

    $("modalBody").onclick = function(e){
      if(modalMode !== "draw3") return;
      var pick = e.target.closest("[data-draw-choice]");
      if(!pick) return;

      var choice = pick.getAttribute("data-draw-choice"); // L / C / R
      var flip = $("flip_"+choice);
      if(!flip) return;

      var rowEl = $("drawRow");
      if(rowEl) rowEl.classList.add("busy");

      flip.classList.add("tilePickOutline");
      modalMode = "draw_busy";

      var idx = pickIndexFromBag(choice);
      if(idx === null || idx === undefined){
        closeModal();
        toast("No tiles left.");
        persist(); render();
        return;
      }

      var t0 = m.bag.splice(idx, 1)[0];
      pl.hand.push(t0);
      pl.didDrawThisTurn = true;

      /* draw counter (for tutorial logic) */
      state.flags.p1DrawCount = (state.flags.p1DrawCount || 0) + 1;

      var front = $("front_"+choice);
      if(front) front.textContent = t0.name;

      if(window.requestAnimationFrame){
        window.requestAnimationFrame(function(){ flip.classList.add("reveal"); });
      }else{
        flip.classList.add("reveal");
      }

      setTimeout(function(){
        closeModal();
        persist();
        render();

        /* tutorial behavior:
           - show once at app start (boot) unless hidden
           - after second draw, show only if NOT hidden and not already shown after second draw
        */
        if(state.flags.p1DrawCount >= 2 && !state.settings.tutorialHidden && !state.flags.tutorialShownAfterSecondDraw){
          state.flags.tutorialShownAfterSecondDraw = true;
          persist();
          openTutorialModal();
        }
      }, 1150);
    };
  }

  // --- validation/detection ---
  function diffCtx(){
    var diff = state.settings.difficulty || "Easy";
    return {
      kitchenOpen: !!(state.match && state.match.kitchenOpen),
      difficulty: diff,
      strict: isStrict(diff),
      loose: isLoose(diff)
    };
  }
  function countOcc(names){
    var m = {};
    for(var i=0;i<names.length;i++){
      var n = names[i];
      m[n] = (m[n] || 0) + 1;
    }
    return m;
  }

  function validateRecipeForSelection(recipeKey, tileObjs, ctx){
    var r = recipeByKey(recipeKey);
    if(!r) return {ok:false, reason:"Unknown recipe."};

    tileObjs = tileObjs || [];
    var names = [];
    for(var i=0;i<tileObjs.length;i++) names.push(tileObjs[i].name);

    var occ = countOcc(names);

    var wildCount = 0;
    var nonWild = [];
    for(i=0;i<names.length;i++){
      if(isWild(names[i])) wildCount++;
      else nonWild.push(names[i]);
    }

    var hasWet = false;
    for(i=0;i<nonWild.length;i++){ if(isWet(nonWild[i])){ hasWet=true; break; } }
    if(RULES.wetLockedUntilKitchen && !ctx.kitchenOpen && hasWet){
      return {ok:false, reason:"Wet locked until Kitchen Open."};
    }

    var reqDry = ctx.strict ? RULES.tacoDryStrict : RULES.tacoDryLoose;

    /* Kid's Rice and Beans (starter pass):
       Required: Rice + 1 Bean
       Optional: Avocado and/or Tortilla(s)
       +1 point if ANY tortilla OR avocado is included
       No other ingredients allowed
    */
    if(r.kind === "kids"){
      if(tileObjs.length < 2 || tileObjs.length > 4) return {ok:false, reason:"Use 2-4 tiles."};

      var hasRice = false;
      var beanCount = 0;
      var hasTort = false;
      var hasAvo = false;

      for(i=0;i<nonWild.length;i++){
        var n0 = nonWild[i];
        if(n0 === "Rice") hasRice = true;
        else if(isBean(n0)) beanCount++;
        else if(isTortilla(n0)) hasTort = true;
        else if(n0 === "Avocado") hasAvo = true;
        else return {ok:false, reason:"Only Rice, a Bean, optional Tortilla/Avocado."};
      }

      /* wild can cover missing rice/bean */
      if(!hasRice && wildCount>0){ hasRice = true; wildCount--; }
      if(beanCount < 1 && wildCount>0){ beanCount = 1; wildCount--; }

      if(!hasRice) return {ok:false, reason:"Needs Rice."};
      if(beanCount < 1) return {ok:false, reason:"Needs 1 Bean."};

      /* scoring */
      var bonus = (hasTort || hasAvo) ? 1 : 0;
      var pts = r.base + bonus;

      return {ok:true, recipeKey:r.key, name:r.name, base:r.base, points:pts, grillBonus:0, extras:bonus, laurensLunch:false};
    }

    // Breakfast Taco: tortilla + egg required only
    if(r.kind === "breakfast"){
      var hasTort1 = false, hasEgg1 = false;
      for(i=0;i<nonWild.length;i++){
        if(isTortilla(nonWild[i])) hasTort1 = true;
        if(isEgg(nonWild[i])) hasEgg1 = true;
      }
      if(!hasTort1 && wildCount>0) hasTort1 = true;
      if(!hasEgg1 && wildCount>0) hasEgg1 = true;
      if(!hasTort1 || !hasEgg1) return {ok:false, reason:"Needs tortilla + egg."};

      for(i=0;i<nonWild.length;i++){
        if(nonWild[i]==="Sour Cream" || nonWild[i]==="Charro Beans" || nonWild[i]==="Black Beans"){
          return {ok:false, reason:"Breakfast taco: no sour cream/charro/black beans."};
        }
      }
      var wetCount = 0;
      for(i=0;i<nonWild.length;i++) if(isWet(nonWild[i])) wetCount++;
      if(wetCount > 1) return {ok:false, reason:"Only 1 wet topping."};

      if(tileObjs.length > 8) return {ok:false, reason:"Too many tiles."};

      return {ok:true, recipeKey:r.key, name:r.name, base:r.base, points:r.base, grillBonus:0, extras:0, laurensLunch:false};
    }

    // Chips & Dip: exactly 2 tiles
    if(r.kind === "chipsDip"){
      if(tileObjs.length !== 2) return {ok:false, reason:"Needs 2 tiles."};
      var hasChips = false, hasDip1 = false;
      for(i=0;i<nonWild.length;i++){
        if(nonWild[i]==="Tortilla Chips") hasChips = true;
        if(isDip(nonWild[i])) hasDip1 = true;
      }
      if(!hasChips && wildCount>0) hasChips = true;
      if(!hasDip1 && wildCount>0) hasDip1 = true;
      if(!hasChips) return {ok:false, reason:"Needs chips."};
      if(!hasDip1) return {ok:false, reason:"Needs a dip."};
      return {ok:true, recipeKey:r.key, name:r.name, base:r.base, points:r.base, grillBonus:0, extras:0, laurensLunch:false};
    }

    // Pico: exactly 4 tiles, no extras
    if(r.kind === "pico"){
      if(tileObjs.length !== 4) return {ok:false, reason:"Needs 4 tiles."};
      var need = { "Tomato":false, "Onion":false, "Cilantro":false, "Lime Juice":false };
      for(i=0;i<nonWild.length;i++){
        if(need.hasOwnProperty(nonWild[i])) need[nonWild[i]] = true;
      }
      if(wildCount>0){
        for(var k in need) if(need.hasOwnProperty(k) && !need[k]){ need[k] = true; wildCount--; }
      }
      if(!need["Tomato"] || !need["Onion"] || !need["Cilantro"] || !need["Lime Juice"]){
        return {ok:false, reason:"Needs Tomato, Onion, Cilantro, Lime."};
      }
      return {ok:true, recipeKey:r.key, name:r.name, base:r.base, points:r.base, grillBonus:0, extras:0, laurensLunch:false};
    }

    // Enchiladas: tort + protein + sauce + cheese, extras capped
    if(r.kind === "ench"){
      if(tileObjs.length < 4) return {ok:false, reason:"Needs more tiles."};
      var hasT = false, hasP = false, hasS = false, hasC = false;
      for(i=0;i<nonWild.length;i++){
        var n1 = nonWild[i];
        if(isTortilla(n1)) hasT = true;
        else if(isProtein(n1)) hasP = true;
        else if(isSauce(n1)) hasS = true;
        else if(isCheese(n1)) hasC = true;
      }
      if(!hasT && wildCount>0) hasT = true;
      if(!hasP && wildCount>0) hasP = true;
      if(!hasS && wildCount>0) hasS = true;
      if(!hasC && wildCount>0) hasC = true;

      if(!hasT) return {ok:false, reason:"Needs tortillas."};
      if(!hasP) return {ok:false, reason:"Needs protein."};
      if(!hasS) return {ok:false, reason:"Needs sauce."};
      if(!hasC) return {ok:false, reason:"Needs cheese."};
      if(tileObjs.length > 7) return {ok:false, reason:"Too many toppings."};

      var base = r.base;
      var grillBonus = 0;
      var prot = null;
      for(i=0;i<nonWild.length;i++){
        if(isProtein(nonWild[i]) && !isEgg(nonWild[i])){ prot = nonWild[i]; break; }
      }
      if(prot && GRILL_PROTEINS[prot]) grillBonus = 1;

      var extras = Math.max(0, tileObjs.length - 4);
      var points = base + grillBonus + extras;
      return {ok:true, recipeKey:r.key, name:r.name, base:base, points:points, grillBonus:grillBonus, extras:extras, laurensLunch:false};
    }

    // Chorizo Taco: tortilla + chorizo + onion + cilantro
    if(r.kind === "chorizo"){
      if(tileObjs.length < 4) return {ok:false, reason:"Needs more tiles."};
      if(ctx.strict && tileObjs.length !== 4) return {ok:false, reason:"Needs 4 tiles."};

      var hasTort2=false, hasChor=false, hasOn=false, hasCil=false;
      for(i=0;i<nonWild.length;i++){
        var n2 = nonWild[i];
        if(isTortilla(n2)) hasTort2=true;
        else if(n2==="Chorizo") hasChor=true;
        else if(n2==="Onion") hasOn=true;
        else if(n2==="Cilantro") hasCil=true;
      }
      if(!hasTort2 && wildCount>0) hasTort2=true;
      if(!hasChor && wildCount>0) hasChor=true;
      if(!hasOn && wildCount>0) hasOn=true;
      if(!hasCil && wildCount>0) hasCil=true;

      if(!hasTort2) return {ok:false, reason:"Needs tortilla."};
      if(!hasChor) return {ok:false, reason:"Needs chorizo."};
      if(!hasOn) return {ok:false, reason:"Needs onion."};
      if(!hasCil) return {ok:false, reason:"Needs cilantro."};

      var base2 = r.base;
      var extras2 = ctx.loose ? Math.max(0, tileObjs.length - 4) : 0;
      return {ok:true, recipeKey:r.key, name:r.name, base:base2, points:base2+extras2, grillBonus:0, extras:extras2, laurensLunch:false};
    }

    // Taco (hard/soft)
    if(r.kind === "taco"){
      if(tileObjs.length < (ctx.strict ? 5 : 3)) return {ok:false, reason:"Needs more tiles."};
      if(tileObjs.length > 8) return {ok:false, reason:"Too many tiles."};

      // required tortilla type
      var hasReqT = false;
      for(i=0;i<nonWild.length;i++){ if(nonWild[i]===r.tortilla) { hasReqT=true; break; } }
      if(!hasReqT && wildCount>0){
        var hasAnyT = false;
        for(i=0;i<nonWild.length;i++){ if(isTortilla(nonWild[i])){ hasAnyT=true; break; } }
        if(!hasAnyT) hasReqT = true;
      }
      if(!hasReqT) return {ok:false, reason:"Use " + r.tortilla + "."};

      // protein
      var hasProt2 = false;
      for(i=0;i<nonWild.length;i++){ if(isProtein(nonWild[i])){ hasProt2=true; break; } }
      if(!hasProt2 && wildCount===0) return {ok:false, reason:"Needs protein."};

      // dry topping count
      var dryCount = 0;
      for(i=0;i<nonWild.length;i++){ if(isDryTopping(nonWild[i])) dryCount++; }
      if(dryCount < reqDry){
        if(wildCount < (reqDry - dryCount)) return {ok:false, reason:"Needs " + reqDry + " dry toppings."};
      }

      // wet max 1
      var wetCount2 = 0;
      for(i=0;i<nonWild.length;i++){ if(isWet(nonWild[i])) wetCount2++; }
      if(wetCount2 > 1) return {ok:false, reason:"Only 1 wet topping."};

      var base3 = r.base;
      var grillBonus2 = 0;
      var prot2 = null;
      for(i=0;i<nonWild.length;i++){
        if(isProtein(nonWild[i]) && !isEgg(nonWild[i])) { prot2 = nonWild[i]; break; }
      }
      if(prot2 && GRILL_PROTEINS[prot2]) grillBonus2 = 1;

      var minReq = ctx.strict ? 5 : 3;
      var extras3 = Math.max(0, tileObjs.length - minReq);
      var pts = base3 + grillBonus2 + extras3;

      // Lauren's Lunch: double lettuce on original play = +5
      var laurens = (occ["Lettuce"] || 0) >= 2;
      if(laurens) pts += 5;

      return {ok:true, recipeKey:r.key, name:r.name, base:base3, points:pts, grillBonus:grillBonus2, extras:extras3, laurensLunch:laurens};
    }

    return {ok:false, reason:"No match."};
  }

  function detectBestDish(tileObjs, ctx){
    tileObjs = tileObjs || [];
    if(tileObjs.length === 0) return {ok:false, reason:"No dish detected yet."};

    var names = [];
    for(var i=0;i<tileObjs.length;i++) names.push(tileObjs[i].name);

    var hasEgg = false, hasTort = false, hasWild = false;
    for(i=0;i<names.length;i++){
      if(names[i]==="Egg") hasEgg = true;
      if(isTortilla(names[i])) hasTort = true;
      if(isWild(names[i])) hasWild = true;
    }
    if(hasWild){ hasEgg = true; hasTort = true; }

    var ordered = [];
    /* Keep kids dish early as a low-point starter option */
    ordered.push("kidsRiceBeans");

    if(hasEgg && hasTort){
      ordered.push("breakfastTaco");
    }else{
      ordered.push("breakfastTaco");
    }
    ordered.push("chipsDip");
    ordered.push("pico");
    ordered.push("chorizoTaco");
    ordered.push("softTaco");
    ordered.push("hardTaco");
    ordered.push("ench");

    var best = null;
    for(i=0;i<ordered.length;i++){
      var k = ordered[i];
      var v = validateRecipeForSelection(k, tileObjs, ctx);
      if(!v.ok) continue;
      if(!best || v.points > best.points) best = v;
    }
    if(!best) return {ok:false, reason:"No dish detected yet."};
    best.ok = true;
    return best;
  }

  // --- publish (Order Up) ---
  function publishSelectionAsDish(pid){
    var m = state.match;
    var pl = m.players[pid];
    var ctx = diffCtx();
    var selected = selectedTilesFor(pid);
    var best = detectBestDish(selected, ctx);
    if(!best.ok) return {ok:false, msg: best.reason};

    var usedIds = (pl.prepSelectedIds || []).slice(0);
    var usedTiles = [];
    for(var i=0;i<usedIds.length;i++){
      var id = usedIds[i];
      var tObj = findTileById(pl.hand, id);
      if(tObj) usedTiles.push(tObj);
    }

    // remove from hand
    for(i=0;i<usedTiles.length;i++){
      for(var j=0;j<pl.hand.length;j++){
        if(pl.hand[j].id === usedTiles[i].id){ pl.hand.splice(j,1); break; }
      }
    }
    pl.prepSelectedIds = [];

    var pub = {
      id: nowId("pub"),
      owner: pid,
      ownerName: pl.name,
      recipeKey: best.recipeKey,
      name: best.name,
      basePts: best.base,
      points: best.points,
      tiles: [],
      isRemix: false
    };
    for(i=0;i<usedTiles.length;i++){
      pub.tiles.push({id: usedTiles[i].id, name: usedTiles[i].name});
    }
    m.publicLine.push(pub);

    // score
    pl.score += best.points;
    pl.servedThisHand += best.points;
    pl.logThisHand.push({ type:"serve", name: best.name, points: best.points });

    // kitchen open gate (Starter Pass for Chips & Dip OR Kid's Rice and Beans)
    var turnPts = best.points;
    if(!m.kitchenOpen){
      var isStarterDish = false;
      for(i=0;i<RULES.starterPassDishKeys.length;i++){
        if(best.recipeKey === RULES.starterPassDishKeys[i]){ isStarterDish = true; break; }
      }
      if(isStarterDish && !pl.starterPassUsed){
        pl.starterPassUsed = true;
        turnPts = 0;
      }
    }
    m.servedThisTurnPts += turnPts;
    if(!m.kitchenOpen && m.servedThisTurnPts >= RULES.openKitchenTurnPts){
      m.kitchenOpen = true;
      toast("Kitchen Open!");
    }

    if(best.laurensLunch){ toast("Lauren's Lunch", 5000); }

    return {ok:true, dish: pub};
  }

  // --- remix (MVP: extend ONE dish by ONE tile, +1 point) ---
  function setRemixSelectedTile(pid, tileId){
    var pl = state.match.players[pid];
    pl.remixSelectedId = (pl.remixSelectedId === tileId) ? null : tileId;
    persist(); render();
  }

  function tryApplyRemixExtend(pid, dishId){
    var m = state.match;
    var pl = m.players[pid];
    var ctx = diffCtx();

    if(!m.kitchenOpen){ toast("Kitchen is closed."); return {ok:false, msg:"Kitchen closed."}; }
    if(!pl.remixSelectedId){ toast("Select a hand tile first."); return {ok:false, msg:"No hand tile selected."}; }

    var tile = findTileById(pl.hand, pl.remixSelectedId);
    if(!tile){ pl.remixSelectedId = null; persist(); render(); return {ok:false, msg:"Tile not found."}; }

    var target = null;
    for(var i=0;i<m.publicLine.length;i++){
      if(m.publicLine[i].id === dishId){ target = m.publicLine[i]; break; }
    }
    if(!target) return {ok:false, msg:"Dish not found."};

    // strict gating: only toppings (dry or wet) or wild can be added
    if(ctx.strict && !(isDryTopping(tile.name) || isWet(tile.name) || isWild(tile.name))){
      toast("Strict: toppings only.");
      return {ok:false, msg:"Strict toppings only."};
    }

    // build tile objects for validation
    var combined = [];
    var arr = target.tiles || [];
    for(i=0;i<arr.length;i++){
      combined.push({ id: arr[i].id, name: arr[i].name });
    }
    combined.push({ id: tile.id, name: tile.name });

    var v = validateRecipeForSelection(target.recipeKey, combined, ctx);
    if(!v.ok){
      toast(v.reason || "Illegal remix.");
      return {ok:false, msg:v.reason || "Illegal remix."};
    }

    // remove tile from hand
    for(i=0;i<pl.hand.length;i++){
      if(pl.hand[i].id === tile.id){ pl.hand.splice(i,1); break; }
    }
    pl.remixSelectedId = null;

    // append to dish
    target.tiles.push({ id: tile.id, name: tile.name });
    target.isRemix = true;

    // scoring: +1 per successful remix
    pl.score += 1;
    pl.remixGainThisHand += 1;
    pl.logThisHand.push({ type:"remix", name:"Remix: " + target.name, points:1, from: target.ownerName });

    toast("Remix! +1", 1400);
    persist(); render();
    return {ok:true};
  }

  // --- simple CPU ---
  function cpuDelayMs(){
    var diff = state.settings.difficulty || "Easy";
    var base = DIFF_DELAY_MS[diff] || 2200;
    return Math.max(450, base + randInt(220));
  }

  function endTurn(pid){
    var m = state.match;
    if(m.activePid !== pid) return;

    var order = [];
    for(var k in m.players) if(m.players.hasOwnProperty(k)) order.push(k);
    order.sort();

    var i = 0;
    for(i=0;i<order.length;i++) if(order[i]===pid) break;
    var next = order[(i+1) % order.length];

    m.activePid = next;
    beginTurn(next);
    persist();
    render();

    if(next !== "P1"){
      setTimeout(function(){ cpuAct(next); }, cpuDelayMs());
    }else{
      toast("Your turn.");
    }
  }

  function cpuAct(pid){
    var m = state.match;
    var pl = m.players[pid];
    if(!pl || pl.isHuman) return;

    var diff = state.settings.difficulty || "Easy";
    var strict = isStrict(diff);

    // strict CPU: attempt a tiny remix if kitchen open
    if(strict && m.kitchenOpen && m.publicLine.length && pl.hand.length){
      var t = null;
      for(var i=0;i<pl.hand.length;i++){
        var nm = pl.hand[i].name;
        if(isDryTopping(nm) || isWet(nm) || isWild(nm)){ t = pl.hand[i]; break; }
      }
      if(t){
        pl.remixSelectedId = t.id;
        tryApplyRemixExtend(pid, m.publicLine[m.publicLine.length-1].id);
        endTurn(pid);
        return;
      }
    }

    // otherwise draw a tile if possible
    if(m.bag.length>0 && !pl.didDrawThisTurn){
      var idx = randInt(m.bag.length);
      var t0 = m.bag.splice(idx,1)[0];
      pl.hand.push(t0);
      pl.didDrawThisTurn = true;
    }

    endTurn(pid);
  }

  // --- prep selection ---
  function togglePrepSelect(pid, tileId){
    var m = state.match;
    var pl = m.players[pid];
    if(m.activePid !== pid){ toast("Not your turn."); return; }

    if(!pl.prepSelectedIds) pl.prepSelectedIds = [];

    var idx = -1;
    for(var i=0;i<pl.prepSelectedIds.length;i++){
      if(pl.prepSelectedIds[i] === tileId){ idx=i; break; }
    }
    if(idx >= 0){
      pl.prepSelectedIds.splice(idx,1);
    }else{
      if(pl.prepSelectedIds.length >= 10){ toast("Prep window is full."); return; }
      pl.prepSelectedIds.push(tileId);
    }
    persist();
    render();
  }

  function clearPrep(pid){
    var pl = state.match.players[pid];
    pl.prepSelectedIds = [];
    persist();
    render();
  }

  // --- auto-plate (simple: find any valid dish from your hand; avoids wild in strict modes) ---
  function computeAutoPlateFromHand(pid){
    var diff = state.settings.difficulty || "Easy";
    if(diff==="Difficult" || diff==="Master Chef") return null;

    var pl = state.match.players[pid];
    var hand = pl.hand || [];
    var ctx = diffCtx();

    // helper: collect ids by name
    function findByName(name){
      for(var i=0;i<hand.length;i++){ if(hand[i].name===name) return hand[i]; }
      return null;
    }
    function findFirst(pred){
      for(var i=0;i<hand.length;i++){ if(pred(hand[i].name)) return hand[i]; }
      return null;
    }
    function pickDryMany(n){
      var out = [];
      for(var i=0;i<hand.length && out.length<n;i++){
        if(isDryTopping(hand[i].name)) out.push(hand[i]);
      }
      return out;
    }

    // try Kid's Rice and Beans first (nice starter)
    var rice = findByName("Rice");
    var bean = findFirst(function(nm){ return isBean(nm); });
    if(rice && bean){
      var ids = [rice.id, bean.id];
      return { ids: ids, name:"Kid's Rice and Beans" };
    }

    // try Breakfast Taco
    var tort = findFirst(function(nm){ return isTortilla(nm); });
    var egg = findByName("Egg");
    if(tort && egg){
      return { ids: [tort.id, egg.id], name:"Breakfast Taco" };
    }

    // try Chips & Dip
    var chips = findByName("Tortilla Chips");
    var dip = findFirst(function(nm){ return isDip(nm); });
    if(chips && dip){
      return { ids: [chips.id, dip.id], name:"Chips & Dip" };
    }

    // basic taco
    var hardT = findByName("Corn Tortillas");
    var softT = findByName("Flour Tortillas");
    var prot = findFirst(function(nm){ return isProtein(nm) && !isEgg(nm); });
    var drys = pickDryMany(ctx.loose ? 1 : 3);
    if((hardT || softT) && prot && drys.length >= (ctx.loose ? 1 : 3)){
      var ids2 = [(softT ? softT.id : hardT.id), prot.id];
      for(var i=0;i<drys.length;i++) ids2.push(drys[i].id);
      return { ids: ids2.slice(0,10), name:"Taco" };
    }

    return null;
  }

  // --- tutorial (wired to images) ---
  var TUTORIAL_IMAGES = [
    "https://prometheangamescom.wordpress.com/wp-content/uploads/2025/12/01-bienvenidos.png",
    "https://prometheangamescom.wordpress.com/wp-content/uploads/2025/12/chatgpt-image-dec-16-2025-11_05_25-am.png",
    "https://prometheangamescom.wordpress.com/wp-content/uploads/2025/12/03-remix.png",
    "https://prometheangamescom.wordpress.com/wp-content/uploads/2025/12/04-lauren.png",
    "https://prometheangamescom.wordpress.com/wp-content/uploads/2025/12/05-difficulty.png"
  ];

  function openTutorialModal(){
    if($("modalWrap").classList.contains("on")) closeModal();
    modalMode = "tutorial";

    var pages = [
      {title:"Next step", text:"Load your Prep Window from your hand. When a dish is detected, Order Up becomes available.", img:TUTORIAL_IMAGES[0]},
      {title:"Opening the kitchen", text:"Serve 10+ points in a single turn to open the kitchen. Once open, wet toppings unlock.", img:TUTORIAL_IMAGES[1]},
      {title:"Remixing", text:"When the kitchen is open, you can remix a dish using at least one tile from your hand.", img:TUTORIAL_IMAGES[2]},
      {title:"Bonuses", text:"Some combos trigger fun bonuses (example: double lettuce shows Lauren's Lunch).", img:TUTORIAL_IMAGES[3]},
      {title:"Difficulty", text:"Beginner/Easy/Medium are forgiving. Difficult/Master Chef are strict and CPUs remix smarter.", img:TUTORIAL_IMAGES[4]}
    ];

    var html = '<div class="tutWrap"><div class="tutStrip" id="tutStrip">';
    for(var i=0;i<pages.length;i++){
      html += ''
        + '<div class="tutPage">'
        +   '<div class="tutTitle">' + escapeHtml(pages[i].title) + '</div>'
        +   '<img class="tutImg" src="' + escapeHtml(pages[i].img) + '" alt="' + escapeHtml(pages[i].title) + '" />'
        +   '<div class="tutText">' + escapeHtml(pages[i].text) + '</div>'
        +   '<div class="hint" style="margin-top:12px;">Swipe to continue.</div>'
        + '</div>';
    }
    html += '</div></div><div class="tutDots" id="tutDots">';
    for(i=0;i<pages.length;i++){
      html += '<div class="dot ' + (i===0 ? 'on' : '') + '"></div>';
    }
    html += '</div>';

    openModal("Tutorial", html, [
      {text:t("hide"), className:"ghost", onClick:function(){
        state.settings.tutorialHidden = true;
        persist();
        closeModal();
        render();
      }},
      {text:t("close"), className:"primary", onClick:function(){ persist(); closeModal(); }}
    ]);

    var strip = $("tutStrip");
    var dotsWrap = $("tutDots");
    var dots = dotsWrap ? dotsWrap.querySelectorAll(".dot") : [];
    function updateDots(){
      if(!strip) return;
      var w = strip.clientWidth || 1;
      var idx = Math.round(strip.scrollLeft / w);
      for(var j=0;j<dots.length;j++){
        if(dots[j].classList) dots[j].classList.toggle("on", j===idx);
      }
    }
    if(strip){
      strip.addEventListener("scroll", function(){
        if(window.requestAnimationFrame) window.requestAnimationFrame(updateDots);
        else updateDots();
      });
    }
  }

  // --- menu guide ---
  function renderMenuGuide(){
    var lines = [];
    lines.push('<div class="label">Kid&#039;s Rice and Beans (2 pts)</div><div class="hint">Required: Rice + 1 Bean. Optional: Tortilla and/or Avocado (+1 total if either is added). No other ingredients allowed. Starter Pass eligible.</div>');
    lines.push('<div class="label">Breakfast Taco (3 pts)</div><div class="hint">Tortilla + Egg required. Wet: max 1. No Sour Cream / Charro Beans / Black Beans.</div>');
    lines.push('<div class="label">Hard Shell Taco (base 5 pts)</div><div class="hint">Corn tortillas + protein + dry toppings. Strict mode requires more toppings.</div>');
    lines.push('<div class="label">Soft Taco (base 5 pts)</div><div class="hint">Flour tortillas + protein + dry toppings.</div>');
    lines.push('<div class="label">Chorizo Taco (base 8 pts)</div><div class="hint">Tortilla + Chorizo + Onion + Cilantro.</div>');
    lines.push('<div class="label">Chips & Dip (5 pts)</div><div class="hint">Tortilla Chips + (Salsa/Guac/Queso). Starter Pass eligible.</div>');
    lines.push('<div class="label">Pico de Gallo (8 pts)</div><div class="hint">Tomato + Onion + Cilantro + Lime Juice. No extras.</div>');
    lines.push('<div class="label">Enchiladas (base 10 pts)</div><div class="hint">Tortillas + Protein + Sauce + Cheese. Up to 3 toppings.</div>');

    var sep = '<div style="height:1px; background: rgba(255,255,255,.06); margin: 12px 0;"></div>';
    $("menuGuideBody").innerHTML = lines.join(sep);
  }

  // --- rendering ---
  function phaseText(){
    var m = state.match;
    if(m.kitchenOpen) return {title:"Kitchen Open", desc:"Wet toppings unlocked. Remix is enabled."};
    if(m.publicLine.length > 0) return {title:"Appetizers Out", desc:"Build toward 10+ points in a single turn to open the kitchen."};
    return {title:"Not Seated Yet", desc:"Serve 10+ points in one turn to open the kitchen."};
  }
  function playerColor(pid){
    var m = state.match;
    return (m.players[pid] && m.players[pid].color) ? m.players[pid].color : "#ffffff";
  }

  function renderPublicLineInto(containerId, allowSelect, selectedDishId){
    var m = state.match;
    var el = $(containerId);
    if(!el) return;

    if(containerId === "publicLine") $("lineSummary").textContent = m.publicLine.length + " dish" + (m.publicLine.length===1 ? "" : "es");
    if(containerId === "remixPublicLine") $("remixLineSummary").textContent = m.publicLine.length + " dish" + (m.publicLine.length===1 ? "" : "es");

    if(!m.publicLine.length){
      el.innerHTML = '<div class="muted small">No dishes in the window yet.</div>';
      return;
    }

    var groups = groupBy(m.publicLine, function(d){ return d.name; });
    var html = "";

    for(var menuItem in groups){
      if(!groups.hasOwnProperty(menuItem)) continue;
      var dishes = groups[menuItem];
      var total = 0;
      for(var i=0;i<dishes.length;i++) total += (dishes[i].points||0);

      html += ''
        + '<div class="pubGroup">'
        +   '<div class="pubGroupTitle">'
        +     '<div>' + escapeHtml(menuItem) + '</div>'
        +     '<span class="badge">Total <span class="mono">' + total + '</span></span>'
        +   '</div>';

      for(i=0;i<dishes.length;i++){
        var d = dishes[i];
        var col = playerColor(d.owner);
        var tintA = hexToRgba(col, 0.28);
        var tiles = "";
        var arr = d.tiles || [];
        for(var j=0;j<arr.length;j++){
          var nm = arr[j].name;
          var cat = ingredientCategory(nm);
          var wild = isWild(nm) ? "wild" : "";
          tiles += '<span class="tile ' + wild + ' cat-' + cat + '" style="cursor:default;">' + escapeHtml(nm) + '</span>';
        }
        var selClass = (allowSelect && selectedDishId && d.id===selectedDishId) ? " dishSel" : "";
        html += ''
          + '<div class="pubDishRow' + selClass + '" data-dish-id="' + escapeHtml(d.id) + '" style="--tintA:' + tintA + ';">'
          +   '<div class="pubDishMeta">'
          +     '<div>' + escapeHtml(d.ownerName) + (d.isRemix ? " • Remix" : "") + '</div>'
          +     '<span class="badge">' + (d.points||0) + ' pts</span>'
          +   '</div>'
          +   '<div class="tiles" style="margin-top:8px;">' + tiles + '</div>'
          + '</div>';
      }

      html += '</div>';
    }

    el.innerHTML = html;
  }

  function renderGameplay(){
    var m = state.match;
    var myTurn = (m.activePid === "P1");

    document.documentElement.style.setProperty("--accent", state.settings.accent);
    document.documentElement.style.setProperty("--accentSoft", hexToRgba(state.settings.accent, 0.14));
    applyDifficultyShimmer();

    $("navGame").textContent = t("gameplay");
    $("navPrep").textContent = t("prep");
    $("navRemix").textContent = t("remix");
    $("navScores").textContent = t("scores");
    $("navSettings").textContent = t("settings");

    $("btnPrep").textContent = t("prepDish");
    $("btnEndTurn").textContent = t("endTurn");

    $("btnPrep").classList.toggle("pulse", myTurn);

    $("tilesRemainBadge").textContent = "Tiles Remaining " + m.bag.length;
    $("kitchenBadge").textContent = m.kitchenOpen ? "Kitchen Open" : "Kitchen Closed";
    $("handBadge").textContent = "Hand " + m.handIndex + "/" + (state.settings.handsTotal || 12);
    $("turnBadge").textContent = myTurn ? "Your Turn" : (m.players[m.activePid].name + "'s Turn");

    var ph = phaseText();
    $("phaseTitle").textContent = ph.title;
    $("phaseDesc").textContent = ph.desc;

    $("btnPrep").disabled = !myTurn;
    $("btnEndTurn").disabled = !myTurn;

    renderPublicLineInto("publicLine", false, null);
  }

  function renderPrep(){
    var m = state.match;
    var pl = p1();
    var myTurn = (m.activePid === "P1");

    $("prepTurnBadge").textContent = myTurn ? "Your Turn" : (m.players[m.activePid].name + "'s Turn");
    $("handCountHint").textContent = (pl.hand ? pl.hand.length : 0) + " tiles";

    $("btnDraw").textContent = t("drawTile");
    $("btnDraw").disabled = (!myTurn) || pl.didDrawThisTurn || (m.bag.length===0);
    $("btnDraw").classList.toggle("pulse", myTurn && !pl.didDrawThisTurn && m.bag.length>0);

    var ids = (pl.prepSelectedIds || []).slice(0,10);
    $("prepLoadedHint").textContent = ids.length + "/10 loaded";

    var selected = selectedTilesFor("P1");
    var ctx = diffCtx();
    var best = detectBestDish(selected, ctx);

    // slots
    var slotsHtml = "";
    for(var i=0;i<10;i++){
      var tObj = selected[i];
      if(!tObj){
        slotsHtml += '<div class="slot" style="cursor:default;"><div class="sHint">Empty</div></div>';
      }else{
        var cat = ingredientCategory(tObj.name);
        slotsHtml += ''
          + '<div class="slot filled" data-prep-remove="' + escapeHtml(tObj.id) + '">'
          +   '<div class="sName">' + escapeHtml(tObj.name) + '</div>'
          +   '<div class="muted2 small" style="margin-top:6px;">' + escapeHtml(categoryLabel(cat)) + '</div>'
          + '</div>';
      }
    }
    $("prepSlots").innerHTML = slotsHtml;
    $("prepStatus").textContent = best.ok ? (best.name + " detected.") : best.reason;

    var canOrder = myTurn && best.ok;
    $("btnOrderUpFromPrep").classList.toggle("pulseOrder", canOrder);
    $("btnOrderUpFromPrep").classList.toggle("inactive", !canOrder);
    $("btnOrderUpFromPrep").textContent = t("orderUp");

    // auto-plate visibility
    var diff = state.settings.difficulty || "Easy";
    var showAutoPlate = myTurn && (diff==="Beginner" || diff==="Easy" || diff==="Medium");
    $("btnAutoPlate").style.display = showAutoPlate ? "inline-flex" : "none";

    var plate = showAutoPlate ? computeAutoPlateFromHand("P1") : null;
    $("btnAutoPlate").disabled = !plate;

    // auto-remix (Beginner only)
    var showAutoRemix = myTurn && diff==="Beginner" && m.kitchenOpen;
    $("btnAutoRemix").style.display = showAutoRemix ? "inline-flex" : "none";
    $("btnAutoRemix").disabled = !showAutoRemix;

    // hand groups
    var grouped = groupBy(pl.hand || [], function(ti){ return ingredientCategory(ti.name); });
    var order = ["tortilla","protein","cheese","wet","drytop","wild","other"];
    var handHtml = '<div class="handGroups">';
    for(var oi=0;oi<order.length;oi++){
      var cat2 = order[oi];
      var tiles = grouped[cat2] || [];
      if(!tiles.length) continue;

      handHtml += ''
        + '<div class="handGroup">'
        +   '<div class="handGroupTitle">'
        +     '<span>' + escapeHtml(categoryLabel(cat2)) + '</span>'
        +     '<span class="count">' + tiles.length + '</span>'
        +   '</div>'
        +   '<div class="tiles">';

      for(var j=0;j<tiles.length;j++){
        var ti = tiles[j];
        var inPrep = false;
        var selIds = pl.prepSelectedIds || [];
        for(var s=0;s<selIds.length;s++){ if(selIds[s]===ti.id){ inPrep=true; break; } }
        var wild = isWild(ti.name) ? "wild" : "";
        handHtml += '<span class="tile ' + (inPrep ? "sel " : "") + wild + ' cat-' + cat2 + '" data-htile="' + escapeHtml(ti.id) + '">' +
                      escapeHtml(ti.name) +
                    '</span>';
      }

      handHtml += '</div></div>';
    }
    handHtml += '</div>';
    $("handTiles").innerHTML = handHtml;

    renderMenuGuide();
  }

  function renderRemix(){
    var m = state.match;
    var pl = p1();
    var myTurn = (m.activePid === "P1");

    $("remixGateBadge").textContent = m.kitchenOpen ? "Kitchen Open" : "Kitchen Closed";
    $("remixHint").textContent = m.kitchenOpen
      ? "Select 1 tile from your hand, then tap a dish to add it. +1 point for a legal remix."
      : "Kitchen is closed. Open the kitchen to unlock remix.";

    $("remixHandCountHint").textContent = (pl.hand ? pl.hand.length : 0) + " tiles";

    // public line (selectable)
    renderPublicLineInto("remixPublicLine", true, null);

    // hand (single-select)
    var grouped = groupBy(pl.hand || [], function(ti){ return ingredientCategory(ti.name); });
    var order = ["drytop","wet","cheese","tortilla","protein","wild","other"];
    var handHtml = '<div class="handGroups">';
    for(var oi=0;oi<order.length;oi++){
      var cat2 = order[oi];
      var tiles = grouped[cat2] || [];
      if(!tiles.length) continue;

      handHtml += ''
        + '<div class="handGroup">'
        +   '<div class="handGroupTitle">'
        +     '<span>' + escapeHtml(categoryLabel(cat2)) + '</span>'
        +     '<span class="count">' + tiles.length + '</span>'
        +   '</div>'
        +   '<div class="tiles">';

      for(var j=0;j<tiles.length;j++){
        var ti = tiles[j];
        var isSel = (pl.remixSelectedId && pl.remixSelectedId === ti.id);
        var wild = isWild(ti.name) ? "wild" : "";
        handHtml += '<span class="tile ' + (isSel ? "sel " : "") + wild + ' cat-' + cat2 + '" data-rtile="' + escapeHtml(ti.id) + '">' +
                      escapeHtml(ti.name) +
                    '</span>';
      }

      handHtml += '</div></div>';
    }
    handHtml += '</div>';
    $("remixHandTiles").innerHTML = handHtml;

    // disable interactions hint if not your turn
    if(!myTurn){
      $("remixHint").textContent = "Not your turn.";
    }
  }

  function renderScores(){
    var m = state.match;
    var pl = p1();

    $("scoreModePill").textContent = (state.settings.mode === "campaign") ? "Campaign" : "Standard";
    $("scoreCurrent").textContent = "Current: " + pl.score;
    $("scoreServedMuted").textContent = "Served this hand: " + pl.servedThisHand;

    var players = [];
    for(var pid in m.players) if(m.players.hasOwnProperty(pid)) players.push(m.players[pid]);
    players.sort(function(a,b){ return a.id < b.id ? -1 : 1; });

    var out = "";
    for(var i=0;i<players.length;i++){
      var p = players[i];
      var col = playerColor(p.id);
      var tintA = hexToRgba(col, 0.18);

      var dishLines = "";
      if(p.logThisHand && p.logThisHand.length){
        for(var j=0;j<p.logThisHand.length;j++){
          var ev = p.logThisHand[j];
          var extra = (ev.type==="remix") ? ' <span class="muted2 small">(from ' + escapeHtml(ev.from || "—") + ')</span>' : '';
          dishLines += ''
            + '<div class="row sp" style="gap:12px; margin-top:8px;">'
            +   '<div style="font-weight:900;">' + escapeHtml(ev.name) + extra + '</div>'
            +   '<span class="badge">' + ev.points + '</span>'
            + '</div>';
        }
      }else{
        dishLines = '<div class="muted small">No dishes served yet this hand.</div>';
      }

      var net = (p.remixGainThisHand||0) - (p.remixLossThisHand||0);
      var netTxt = (net===0) ? "0" : (net>0 ? ("+"+net) : String(net));

      out += ''
        + '<details class="acc" style="margin-top:12px; background: rgba(255,255,255,.03);">'
        +   '<summary>'
        +     '<span>' + escapeHtml(p.name) + (p.id==="P1" ? " (You)" : "") + '</span>'
        +     '<span class="badge">Score ' + p.score + '</span>'
        +   '</summary>'
        +   '<div class="accBody" style="position:relative; overflow:hidden;">'
        +     '<div style="position:absolute; inset:0; background: linear-gradient(135deg, ' + tintA + ', transparent 70%); opacity:.9; pointer-events:none;"></div>'
        +     '<div style="position:relative; z-index:1;">'
        +       '<div class="row wrap" style="gap:10px; margin-top:6px;">'
        +         '<span class="pill">Served: ' + p.servedThisHand + '</span>'
        +         '<span class="pill">Remix Net: ' + netTxt + '</span>'
        +       '</div>'
        +       '<div style="height:1px; background: rgba(255,255,255,.06); margin: 12px 0;"></div>'
        +       dishLines
        +     '</div>'
        +   '</div>'
        + '</details>';
    }
    $("scoreList").innerHTML = out;
  }

  function fillSettings(){
    var sd = $("selDifficulty");
    if(sd){
      sd.innerHTML = "";
      for(var i=0;i<DIFFS.length;i++){
        var op = document.createElement("option");
        op.value = DIFFS[i];
        op.textContent = DIFFS[i];
        sd.appendChild(op);
      }
      sd.value = state.settings.difficulty;
    }

    var sa = $("selAccent");
    if(sa){
      sa.innerHTML = "";
      for(i=0;i<ACCENTS.length;i++){
        op = document.createElement("option");
        op.value = ACCENTS[i].val;
        op.textContent = ACCENTS[i].name + " (" + ACCENTS[i].val + ")";
        sa.appendChild(op);
      }
      sa.value = state.settings.accent;
    }

    $("selMode").value = state.settings.mode;
    $("selPlayers").value = String(state.settings.players);
    $("inpHands").value = state.settings.handsTotal;
    $("inpTilesPerPlayer").value = state.settings.tilesPerPlayer;
    $("selDecks").value = String(state.settings.decks);
    $("selLang").value = state.settings.lang;

    var btn = $("btnToggleTutorialHidden");
    if(btn){
      btn.textContent = "Hide Tutorial: " + (state.settings.tutorialHidden ? "On" : "Off");
    }
  }

  function setNavActive(btnId){
    var ids = ["navGame","navPrep","navRemix","navScores","navSettings"];
    for(var i=0;i<ids.length;i++){
      $(ids[i]).classList.toggle("active", ids[i]===btnId);
    }
  }

  function setPage(p){
    state.ui.page = p;
    persist();
    render();
  }

  function render(){
    if(!state.match) newMatch();

    $("pageGameplay").classList.remove("on");
    $("pagePrep").classList.remove("on");
    $("pageRemix").classList.remove("on");
    $("pageScores").classList.remove("on");
    $("pageSettings").classList.remove("on");

    if(state.ui.page==="gameplay"){ $("pageGameplay").classList.add("on"); setNavActive("navGame"); }
    if(state.ui.page==="prep"){ $("pagePrep").classList.add("on"); setNavActive("navPrep"); }
    if(state.ui.page==="remix"){ $("pageRemix").classList.add("on"); setNavActive("navRemix"); }
    if(state.ui.page==="scores"){ $("pageScores").classList.add("on"); setNavActive("navScores"); }
    if(state.ui.page==="settings"){ $("pageSettings").classList.add("on"); setNavActive("navSettings"); }

    fillSettings();
    renderGameplay();
    renderPrep();
    renderRemix();
    renderScores();
  }

  // --- wire UI ---
  function wire(){
    $("navGame").onclick = function(){ setPage("gameplay"); };
    $("navPrep").onclick = function(){ setPage("prep"); };
    $("navRemix").onclick = function(){ setPage("remix"); };
    $("navScores").onclick = function(){ setPage("scores"); };
    $("navSettings").onclick = function(){ setPage("settings"); };

    $("btnNewMatchTop").onclick = function(){
      openModal("New Match", "Start a fresh match? This overwrites current match state.", [
        {text:t("cancel"), className:"ghost", onClick: closeModal},
        {text:t("start"), className:"primary", onClick: function(){ closeModal(); newMatch(); }}
      ]);
    };

    $("btnPrep").onclick = function(){
      if(state.match.activePid !== "P1"){ toast("Not your turn."); return; }
      setPage("prep");
    };

    $("btnEndTurn").onclick = function(){
      if(state.match.activePid !== "P1"){ toast("Not your turn."); return; }
      endTurn("P1");
    };

    function orderUpCommon(goToGameplay){
      if(state.match.activePid !== "P1"){ toast("Not your turn."); return; }

      var sel = selectedTilesFor("P1");
      var best = detectBestDish(sel, diffCtx());
      if(best.ok){
        var res = publishSelectionAsDish("P1");
        if(!res.ok){ toast(res.msg || "No qualifying dish."); return; }
        persist(); render();
        if(goToGameplay) setPage("gameplay");
        toast("Order up!");
        return;
      }
      
      if(sel.length === 0){
        toast("Tip: Select tiles from your hand first, then Order Up!");
      } else {
        var tip = getOrderUpTip(sel);
        toast(tip);
      }
    }

    function getOrderUpTip(sel){
      if(sel.length < 3) return "Tip: Most dishes need at least 3 tiles.";
      
      var hasTortilla = false, hasProtein = false, hasCheese = false;
      var wetCount = 0;
      for(var i = 0; i < sel.length; i++){
        var name = sel[i].name;
        if(isTortilla(name) || isWild(name)) hasTortilla = true;
        if(isProtein(name) || isWild(name)) hasProtein = true;
        if(isCheese(name)) hasCheese = true;
        if(isWet(name)) wetCount++;
      }
      
      if(wetCount > 1) return "Tip: Only 1 wet topping allowed per dish!";
      if(!hasTortilla && !hasProtein) return "Tip: Add a tortilla or protein to start a dish.";
      if(!hasTortilla) return "Tip: Most tacos need a tortilla (Soft, Hard, or Flour).";
      if(!hasProtein) return "Tip: Add a protein like Chicken, Steak, or Carnitas.";
      if(!hasCheese) return "Tip: Try adding cheese to complete your dish.";
      
      return "Tip: Check your ingredients - something's missing for a valid dish.";
    }

    $("btnOrderUpFromPrep").onclick = function(){ orderUpCommon(true); };

    $("btnDraw").onclick = openDrawModal;

    $("btnClearPrep").onclick = function(){ clearPrep("P1"); };

    $("btnAutoPlate").onclick = function(){
      if(state.match.activePid !== "P1"){ toast("Not your turn."); return; }
      var best = computeAutoPlateFromHand("P1");
      if(!best){ toast("No valid plate found."); return; }
      p1().prepSelectedIds = best.ids.slice(0,10);
      persist(); render();
      toast("Auto-Plate loaded.");
    };

    $("btnAutoRemix").onclick = function(){
      toast("Auto-Remix is not wired in this MVP.");
    };

    // hand click (prep)
    $("handTiles").addEventListener("click", function(e){
      var el = e.target.closest("[data-htile]");
      if(!el) return;
      togglePrepSelect("P1", el.getAttribute("data-htile"));
    });

    // remove from prep slots (prep page)
    $("prepSlots").addEventListener("click", function(e){
      var el = e.target.closest("[data-prep-remove]");
      if(!el) return;
      var id = el.getAttribute("data-prep-remove");
      var pl = p1();
      var next = [];
      for(var i=0;i<(pl.prepSelectedIds||[]).length;i++){
        if(pl.prepSelectedIds[i] !== id) next.push(pl.prepSelectedIds[i]);
      }
      pl.prepSelectedIds = next;
      persist(); render();
    });

    // remix: select one hand tile
    $("remixHandTiles").addEventListener("click", function(e){
      var el = e.target.closest("[data-rtile]");
      if(!el) return;
      if(state.match.activePid !== "P1"){ toast("Not your turn."); return; }
      setRemixSelectedTile("P1", el.getAttribute("data-rtile"));
    });

    // remix: tap dish to apply
    $("remixPublicLine").addEventListener("click", function(e){
      var el = e.target.closest("[data-dish-id]");
      if(!el) return;
      if(state.match.activePid !== "P1"){ toast("Not your turn."); return; }
      tryApplyRemixExtend("P1", el.getAttribute("data-dish-id"));
    });

    // settings
    $("selMode").onchange = function(){ state.settings.mode = $("selMode").value; persist(); render(); toast("Mode updated."); };
    $("selPlayers").onchange = function(){ state.settings.players = parseInt($("selPlayers").value,10) || 4; persist(); newMatch(); };
    $("selDifficulty").onchange = function(){ state.settings.difficulty = $("selDifficulty").value; persist(); render(); };
    $("inpHands").onchange = function(){ state.settings.handsTotal = clamp(parseInt($("inpHands").value,10) || 12, 1, 12); persist(); render(); };
    $("inpTilesPerPlayer").onchange = function(){ state.settings.tilesPerPlayer = clamp(parseInt($("inpTilesPerPlayer").value,10) || 16, 8, 24); persist(); newMatch(); };
    $("selDecks").onchange = function(){ state.settings.decks = parseInt($("selDecks").value,10) || 2; persist(); newMatch(); };
    $("selAccent").onchange = function(){
      state.settings.accent = $("selAccent").value;
      document.documentElement.style.setProperty("--accent", state.settings.accent);
      document.documentElement.style.setProperty("--accentSoft", hexToRgba(state.settings.accent, 0.14));
      if(state.match){
        state.match.players["P1"].color = state.settings.accent;
        var cpuCols = ensureUniqueCpuColors();
        if(state.match.players["P2"]) state.match.players["P2"].color = cpuCols[0];
        if(state.match.players["P3"]) state.match.players["P3"].color = cpuCols[1];
        if(state.match.players["P4"]) state.match.players["P4"].color = cpuCols[2];
      }
      persist(); render();
    };
    $("selLang").onchange = function(){ state.settings.lang = $("selLang").value; persist(); render(); };
    $("btnViewTutorial").onclick = openTutorialModal;

    $("btnToggleTutorialHidden").onclick = function(){
      state.settings.tutorialHidden = !state.settings.tutorialHidden;
      persist(); render();
      toast("Tutorial " + (state.settings.tutorialHidden ? "hidden." : "enabled."));
    };
  }

  // --- boot ---
  function boot(){
    document.documentElement.style.setProperty("--accent", state.settings.accent);
    document.documentElement.style.setProperty("--accentSoft", hexToRgba(state.settings.accent, 0.14));
    applyDifficultyShimmer();

    // ensure match structure (older saves)
    if(state.match && state.match.players){
      if(state.match.players["P1"]) state.match.players["P1"].color = state.settings.accent;
      var cpuCols = ensureUniqueCpuColors();
      if(state.match.players["P2"]) state.match.players["P2"].color = cpuCols[0];
      if(state.match.players["P3"]) state.match.players["P3"].color = cpuCols[1];
      if(state.match.players["P4"]) state.match.players["P4"].color = cpuCols[2];

      for(var pid in state.match.players){
        if(!state.match.players.hasOwnProperty(pid)) continue;
        var p = state.match.players[pid];
        if(!p.prepSelectedIds) p.prepSelectedIds = [];
        if(!p.hand) p.hand = [];
        if(!p.logThisHand) p.logThisHand = [];
        if(typeof p.remixSelectedId === "undefined") p.remixSelectedId = null;
        if(typeof p.starterPassUsed === "undefined") p.starterPassUsed = false;
      }
    }

    wire();
    if(!state.match) newMatch();
    render();

    // Tutorial auto-show: only at app start, unless hidden (and only once)
    if(!state.settings.tutorialHidden && !state.flags.tutorialShownAtStart){
      state.flags.tutorialShownAtStart = true;
      persist();
      setTimeout(function(){ openTutorialModal(); }, 350);
    }
  }

  boot();
})();
  </script>
</body>
</html>
